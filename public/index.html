<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√Ωbƒõr semin√°≈ô≈Ø</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container { 
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }
        h1 { 
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
        }
        .screen { display: none; }
        .screen.active { display: block; }
        input, select, button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        button:active { transform: translateY(0); }
        .button-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        .seminar-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #667eea;
        }
        .seminar-card h3 { 
            color: #333;
            margin-bottom: 10px;
        }
        .seminar-card p {
            color: #666;
            margin: 5px 0;
        }
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        .filter-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            width: auto;
        }
        .filter-btn.active, .filter-btn:hover {
            background: #667eea;
            color: white;
        }
        .priority-section {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .priority-label {
            font-weight: bold;
            color: #667eea;
            margin: 15px 0 5px 0;
            display: block;
        }
        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 5px solid #c33;
        }
        .success {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 5px solid #3c3;
        }
        #adminResults {
            max-height: 500px;
            overflow-y: auto;
        }
        .result-seminar {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        .result-seminar h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .student-item {
            background: white;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            width: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="screen active">
            <h1>üéì V√Ωbƒõr semin√°≈ô≈Ø</h1>
            <input type="text" id="usernameInput" placeholder="P≈ôihla≈°ovac√≠ jm√©no (prijmeni.jmeno)">
            <input type="password" id="adminPasswordInput" placeholder="Admin heslo (pouze pro admina)" style="display:none;">
            <button onclick="login()">P≈ôihl√°sit</button>
            <button class="button-secondary" onclick="showScreen('browseScreen')">Prohl√≠≈æet semin√°≈ôe</button>
            <div id="loginError"></div>
        </div>

        <!-- Browse Seminars Screen -->
        <div id="browseScreen" class="screen">
            <h1>üìö P≈ôehled v≈°ech semin√°≈ô≈Ø</h1>
            <div class="filters">
                <button class="filter-btn active" onclick="filterSeminars('all')">V≈°echny</button>
                <button class="filter-btn" onclick="filterSeminars('languages')">Jazyky</button>
                <button class="filter-btn" onclick="filterSeminars('science')">P≈ô√≠rodn√≠ vƒõdy</button>
                <button class="filter-btn" onclick="filterSeminars('humanities')">Humanitn√≠</button>
                <button class="filter-btn" onclick="filterSeminars('arts')">Umƒõn√≠ a kreativita</button>
                <button class="filter-btn" onclick="filterSeminars('wellness')">Wellness</button>
                <button class="filter-btn" onclick="filterSeminars('other')">Ostatn√≠</button>
            </div>
            <div id="seminarsList"></div>
            <button class="button-secondary" onclick="showScreen('loginScreen')">Zpƒõt na p≈ôihl√°≈°en√≠</button>
        </div>

        <!-- Student Selection Screen -->
        <div id="selectionScreen" class="screen">
            <h1>üéØ Vyber 5 priorit</h1>
            <div class="priority-section">
                <label class="priority-label">1. priorita (nejd≈Øle≈æitƒõj≈°√≠)</label>
                <select id="priority1"></select>
                
                <label class="priority-label">2. priorita</label>
                <select id="priority2"></select>
                
                <label class="priority-label">3. priorita</label>
                <select id="priority3"></select>
                
                <label class="priority-label">4. priorita</label>
                <select id="priority4"></select>
                
                <label class="priority-label">5. priorita</label>
                <select id="priority5"></select>
            </div>
            <button onclick="submitPriorities()">Odeslat priority</button>
            <button class="button-secondary" onclick="logout()">Odhl√°sit a p≈ôihl√°sit jin√©ho</button>
            <div id="selectionMessage"></div>
        </div>

        <!-- Admin Screen -->
        <div id="adminScreen" class="screen">
            <h1>üë®‚Äçüíº Admin: p≈ôihl√°≈°ky a v√Ωsledky</h1>
            <button onclick="evaluateSelections()">Uzav≈ô√≠t a vyhodnotit</button>
            <button onclick="reopenRegistration()">Otev≈ô√≠t registraci znovu</button>
            <button class="button-secondary" onclick="logout()">Odhl√°sit a p≈ôihl√°sit jin√©ho</button>
            <div id="adminResults"></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let isAdmin = false;
        let adminSecret = null;
        let allSeminars = [];

        const categoryMap = {
            languages: [3, 4, 6, 7, 10],
            science: [1, 2, 3, 9],
            humanities: [4, 11],
            arts: [5, 7],
            wellness: [8],
            other: []
        };

        async function login() {
            const username = document.getElementById('usernameInput').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            if (!username) {
                errorDiv.innerHTML = '<div class="error">Zadej sv√© p≈ôihla≈°ovac√≠ jm√©no!</div>';
                return;
            }

            if (username.toLowerCase() === 'admin') {
                const password = document.getElementById('adminPasswordInput').value;
                document.getElementById('adminPasswordInput').style.display = 'block';
                
                if (!password) {
                    errorDiv.innerHTML = '<div class="error">Zadej admin heslo!</div>';
                    return;
                }

                try {
                    const res = await fetch('/api/admin/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    const data = await res.json();
                    
                    if (data.ok) {
                        isAdmin = true;
                        adminSecret = data.secret;
                        currentUser = 'admin';
                        await loadAdminData();
                        showScreen('adminScreen');
                    } else {
                        errorDiv.innerHTML = '<div class="error">Nespr√°vn√© admin heslo!</div>';
                    }
                } catch (err) {
                    errorDiv.innerHTML = '<div class="error">Chyba p≈ôi p≈ôihla≈°ov√°n√≠!</div>';
                }
            } else {
                currentUser = username;
                await loadSeminars();
                showScreen('selectionScreen');
            }
        }

        async function loadSeminars() {
            try {
                const res = await fetch('/api/seminars');
                const data = await res.json();
                allSeminars = data.seminars;
                
                for (let i = 1; i <= 5; i++) {
                    const select = document.getElementById(`priority${i}`);
                    select.innerHTML = '<option value="">-- Vyber semin√°≈ô --</option>';
                    allSeminars.forEach(s => {
                        select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                    });
                }
            } catch (err) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ semin√°≈ô≈Ø:', err);
            }
        }

        async function submitPriorities() {
            const priorities = [];
            for (let i = 1; i <= 5; i++) {
                const val = document.getElementById(`priority${i}`).value;
                if (!val) {
                    document.getElementById('selectionMessage').innerHTML = 
                        '<div class="error">Mus√≠≈° vybrat v≈°ech 5 priorit!</div>';
                    return;
                }
                priorities.push(parseInt(val));
            }

            if (new Set(priorities).size !== 5) {
                document.getElementById('selectionMessage').innerHTML = 
                    '<div class="error">Ka≈æd√Ω semin√°≈ô mus√≠ b√Ωt jin√Ω!</div>';
                return;
            }

            try {
                const res = await fetch('/api/select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, priorities })
                });
                const data = await res.json();
                
                if (data.ok) {
                    document.getElementById('selectionMessage').innerHTML = 
                        '<div class="success">' + data.message + '</div>';
                } else {
                    document.getElementById('selectionMessage').innerHTML = 
                        '<div class="error">' + data.error + '</div>';
                }
            } catch (err) {
                document.getElementById('selectionMessage').innerHTML = 
                    '<div class="error">Chyba p≈ôi odes√≠l√°n√≠!</div>';
            }
        }

        async function loadAdminData() {
            try {
                const res = await fetch(`/api/admin/selections?secret=${adminSecret}`);
                const data = await res.json();
                
                let html = '<h2>üìã Status: ' + (data.registrationOpen ? 'OTEV≈òENO' : 'UZAV≈òENO') + '</h2>';
                html += '<h3>Celkem p≈ôihl√°≈°ek: ' + data.selections.length + '</h3>';
                
                if (Object.keys(data.evaluationResult).length > 0) {
                    html += '<h2>üéØ V√Ωsledky p≈ôi≈ôazen√≠:</h2>';
                    allSeminars.forEach(sem => {
                        const students = data.evaluationResult[sem.id] || [];
                        html += `<div class="result-seminar">
                            <h4>${sem.name} (${students.length}/${sem.capacity})</h4>`;
                        students.forEach(student => {
                            html += `<div class="student-item">
                                <span>${student}</span>
                                <button class="delete-btn" onclick="deleteStudent('${student}')">Smazat</button>
                            </div>`;
                        });
                        html += '</div>';
                    });
                }
                
                html += '<h2>üìù V≈°echny p≈ôihl√°≈°ky:</h2>';
                data.selections.forEach(sel => {
                    const prioNames = sel.priorities.map(pid => {
                        const sem = allSeminars.find(s => s.id === pid);
                        return sem ? sem.name : 'N/A';
                    });
                    html += `<div class="student-item">
                        <div>
                            <strong>${sel.username}</strong><br>
                            <small>1. ${prioNames[0]}<br>
                            2. ${prioNames[1]}<br>
                            3. ${prioNames[2]}<br>
                            4. ${prioNames[3]}<br>
                            5. ${prioNames[4]}</small>
                        </div>
                        <button class="delete-btn" onclick="deleteStudent('${sel.username}')">Smazat</button>
                    </div>`;
                });
                
                document.getElementById('adminResults').innerHTML = html;
            } catch (err) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ admin dat:', err);
            }
        }

        async function evaluateSelections() {
            try {
                const res = await fetch(`/api/admin/evaluate?secret=${adminSecret}`, { method: 'POST' });
                const data = await res.json();
                if (data.ok) {
                    await loadAdminData();
                    alert('Registrace uzav≈ôena a vyhodnocena!');
                }
            } catch (err) {
                alert('Chyba p≈ôi vyhodnocov√°n√≠!');
            }
        }

        async function reopenRegistration() {
            try {
                const res = await fetch(`/api/admin/reopen?secret=${adminSecret}`, { method: 'POST' });
                const data = await res.json();
                if (data.ok) {
                    await loadAdminData();
                    alert('Registrace znovu otev≈ôena!');
                }
            } catch (err) {
                alert('Chyba p≈ôi otev√≠r√°n√≠ registrace!');
            }
        }

        async function deleteStudent(username) {
            if (!confirm(`Opravdu smazat p≈ôihl√°≈°ku u≈æivatele ${username}?`)) return;
            
            try {
                const res = await fetch(`/api/admin/delete?secret=${adminSecret}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const data = await res.json();
                if (data.ok) {
                    await loadAdminData();
                }
            } catch (err) {
                alert('Chyba p≈ôi maz√°n√≠!');
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function logout() {
            currentUser = null;
            isAdmin = false;
            adminSecret = null;
            document.getElementById('usernameInput').value = '';
            document.getElementById('adminPasswordInput').value = '';
            document.getElementById('adminPasswordInput').style.display = 'none';
            document.getElementById('loginError').innerHTML = '';
            showScreen('loginScreen');
        }

        async function filterSeminars(category) {
            if (!allSeminars.length) {
                const res = await fetch('/api/seminars');
                const data = await res.json();
                allSeminars = data.seminars;
            }

            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            let filtered = allSeminars;
            if (category !== 'all') {
                filtered = allSeminars.filter(s => categoryMap[category]?.includes(s.id));
            }

            let html = '';
            filtered.forEach(s => {
                const lecturers = s.lecturers.length ? s.lecturers.join(', ') : 'TBA';
                html += `<div class="seminar-card">
                    <h3>${s.name}</h3>
                    <p><strong>Lektor:</strong> ${lecturers}</p>
                    <p><strong>Kapacita:</strong> ${s.capacity} m√≠st</p>
                </div>`;
            });
            document.getElementById('seminarsList').innerHTML = html;
        }

        // Inicializace browseru
        filterSeminars('all');
    </script>
</body>
</html>
