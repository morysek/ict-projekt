<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Výběr seminářů</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; color: #222; }
    h1 { margin-bottom: 8px; }
    .row { display: flex; gap: 16px; align-items: center; margin: 12px 0; flex-wrap: wrap; }
    input, button, select { padding: 8px 10px; font-size: 16px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; margin-top: 16px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; background: #fff; }
    .name { font-weight: 600; margin-bottom: 6px; }
    .dim { color: #666; font-size: 14px; }
    .ok { color: #0a7b34; }
    .err { color: #b00020; }
    #status { margin-top: 12px; min-height: 20px; }
    #adminPanel, #userPanel { margin-top: 32px; }
  </style>
</head>
<body>
  <h1>Výběr seminářů</h1>
  <p>Přihlas se emailem a vyber si tři priority seminářů.</p>

  <label for="emailInput">Email:</label>
  <input id="emailInput" placeholder="prijmeni.jmeno@novyporg.cz" type="email" />

  <button id="loginBtn">Přihlásit se</button>

  <div id="status"></div>

  <div id="userPanel" style="display:none;">
    <h2>Vyber tři priority</h2>
    <select id="select1"></select>
    <select id="select2"></select>
    <select id="select3"></select>
    <button id="submitBtn">Odeslat priority</button>
  </div>

  <div id="result" style="margin-top:20px"></div>

  <div id="adminPanel" style="display:none;">
    <h2>Admin Panel</h2>
    <button id="closeRegBtn">Uzavřít registraci a vyhodnotit</button>
    <h3>Aktuální registrace</h3>
    <pre id="registrations"></pre>
  </div>

<script>
  const loginBtn = document.getElementById('loginBtn');
  const emailInput = document.getElementById('emailInput');
  const status = document.getElementById('status');
  const userPanel = document.getElementById('userPanel');
  const adminPanel = document.getElementById('adminPanel');
  const select1 = document.getElementById('select1');
  const select2 = document.getElementById('select2');
  const select3 = document.getElementById('select3');
  const submitBtn = document.getElementById('submitBtn');
  const registrations = document.getElementById('registrations');
  const closeRegBtn = document.getElementById('closeRegBtn');
  const resultDiv = document.getElementById('result');

  let seminars = [];
  let loggedInEmail = '';

  function setStatus(msg, error=false) {
    status.textContent = msg;
    status.style.color = error ? 'red' : 'green';
  }

  async function loadSeminars() {
    try {
      const res = await fetch('/api/seminars');
      const data = await res.json();
      seminars = data.seminars || [];

      [select1, select2, select3].forEach(sel => {
        sel.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Vyber seminář';
        sel.appendChild(defaultOption);

        seminars.forEach(s => {
          const option = document.createElement('option');
          option.value = s.id;
          option.textContent = `${s.name} — ${s.lecturers.join(', ')}`;
          sel.appendChild(option);
        });
      });
    } catch {
      setStatus('Chyba při načítání seminářů', true);
    }
  }

  loginBtn.addEventListener('click', () => {
    const email = emailInput.value.trim().toLowerCase();
    if (!email) {
      setStatus('Vyplň email', true);
      return;
    }

    loggedInEmail = email;
    setStatus('');

    if(email === 'admin') {
      userPanel.style.display = 'none';
      adminPanel.style.display = 'block';
      loadAdminData();
    } else {
      userPanel.style.display = 'block';
      adminPanel.style.display = 'none';
      loadResult();
      loadSeminars();
    }
  });

  submitBtn.addEventListener('click', async () => {
    // Validace vybraných seminářů
    const p1 = select1.value, p2 = select2.value, p3 = select3.value;
    if(!p1 || !p2 || !p3 || p1 === p2 || p1 === p3 || p2 === p3) {
      setStatus('Vyber prosím tři různé priority', true);
      return;
    }

    setStatus('Odesílám priority...');
    try {
      const res = await fetch('/api/selections', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: loggedInEmail, priorities: [Number(p1), Number(p2), Number(p3)] })
      });

      const data = await res.json();
      if(res.ok) {
        setStatus(data.message || 'Priority uloženy');
        await loadResult();
      } else {
        setStatus(data.error || 'Chyba při ukládání', true);
      }

    } catch {
      setStatus('Chyba připojení k serveru', true);
    }
  });

  async function loadAdminData() {
    try {
      const res = await fetch('/api/admin/selections?secret=adminsecret');
      const data = await res.json();
      if(res.ok) {
        registrations.textContent = JSON.stringify(data.selections, null, 2);
        if(!data.registrationOpen) {
          setStatus('Registrace uzavřena.', false);
          loadResult();
        } else {
          setStatus('Registrace otevřena.', false);
        }
      } else {
        setStatus(data.error || 'Chyba', true);
      }
    } catch {
      setStatus('Chyba připojení k serveru', true);
    }
  }

  closeRegBtn.addEventListener('click', async () => {
    try {
      const res = await fetch('/api/admin/close?secret=adminsecret', { method: 'POST' });
      const data = await res.json();
      if(res.ok) {
        setStatus(data.message || 'Registrace byla uzavřena a vyhodnocena');
        loadAdminData();
      } else {
        setStatus(data.error || 'Nepodařilo se uzavřít registraci', true);
      }
    } catch {
      setStatus('Chyba připojení k serveru', true);
    }
  });

  async function loadResult() {
    if (!loggedInEmail || loggedInEmail === 'admin') {
      resultDiv.textContent = '';
      return;
    }

    try {
      const res = await fetch(`/api/result?email=${encodeURIComponent(loggedInEmail)}`);
      const data = await res.json();
      if (res.ok && data.seminarId) {
        const seminář = seminars.find(s => s.id === data.seminarId);
        if(seminář){
          resultDiv.textContent = `Byl/a jsi přijat/a na seminář: ${seminář.name}`;
        } else {
          resultDiv.textContent = 'Na žádný seminář jste nebyl/a přijat/a.';
        }
      } else {
        resultDiv.textContent = 'Na žádný seminář jste nebyl/a přijat/a.';
      }
    } catch {
      resultDiv.textContent = 'Chyba při načítání výsledku.';
    }
  }

  // Načtení seminářů při startu stránky
  loadSeminars();
</script>
</body>
</html>
